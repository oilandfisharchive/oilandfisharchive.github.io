<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenVPN + V2Ray</title>
    <link rel="stylesheet" type="text/css" href="../general.css">
</head>
<body>
    <div id="header">
        <div class="content">
            <h2><a href="..">Oil and Fish</a></h2>
        </div>
    </div>
    <div id="main">
        <div class="content">
            <h1>OpenVPN + V2Ray</h1>
            <p>This is a quick note on the process for setting up OpenVPN+V2Ray on an Ubuntu server and an Ubuntu client. Since this is aimed at intermediate-level users, no
            details are given.</p>
            <h2><a id="1"></a>1. Server</h2>
            <p>1.1. Install V2Ray (Nginx+ws+tls) on the server using the wulabing script from <a href="https://github.com/wulabing/V2Ray_ws-tls_bash_onekey" target="_blank">https://github.com/wulabing/V2Ray_ws-tls_bash_onekey</a>.</p>
            <p>Here is an example configuration generated by the wulabing script:</p>
            <blockquote>
                <code>地址（address）: v2.example.com<br>
                端口（port）： 443<br>
                用户id（UUID）： c7d7f868-1c17-452a-b2f6-64e61a4a6454<br>
                额外id（alterId）： 0<br>
                加密方式（security）： 自适应<br>
                传输协议（network）： ws<br>
                伪装类型（type）： none<br>
                路径（不要落下/）： /1976f7/<br>
                底层传输安全： tls</code>
            </blockquote>
            <p>1.2. Install OpenVPN on the server using the angristan script from <a href="https://github.com/angristan/openvpn-install" target="_blank">https://github.com/angristan/openvpn-install</a>.</p>
            <h2><a id="2"></a>2. Client</h2>
            <p>2.1. Download the generated OpenVPN client configuration file from the server to the client, for example <code>v2.ovpn</code>.</p>
            <p>2.2. Download and unzip the latest V2Ray client for your platform, e.g. <a href="https://github.com/v2fly/v2ray-core/releases/download/v4.44.0/v2ray-linux-64.zip" target="_blank">https://github.com/v2fly/v2ray-core/releases/download/v4.44.0/v2ray-linux-64.zip</a>.</p>
            <p>2.3. Configure the V2Ray client configuration file <code>config.json</code> to match the parameters on the server, and with UDP enabled set to true (since OpenVPN
            is using UDP). Much of the configuration below was copied from the default configuration file supplied with the zip file. Some of it will never apply in our scenario
            (e.g. the routing and dns) because the traffic passing over V2Ray will already be encrypted by OpenVPN.</p>
            <pre>    {
      "log": {
        "loglevel": "warning"
      },
    
      "inbounds": [{
        "port": 1080,
        "listen": "127.0.0.1",
        "tag": "socks-inbound",
        "protocol": "socks",
        "settings": {
          "auth": "noauth",
          "udp": true,
          "ip": "127.0.0.1"
        },
        "sniffing": {
          "enabled": true,
          "destOverride": ["http", "tls"]
        }
      }],
      
      "outbounds": [{
        "protocol": "vmess",
        "settings": {
          "vnext": [{
            "address": "123.123.123.123", 
            "port": 443,
            "users": [
              { "id": "c7d7f868-1c17-452a-b2f6-64e61a4a6454",
                "alterId": 0 }
            ]
          }]
        },
        "streamSettings": {
          "network": "ws",
          "security": "tls",
          "tlsSettings": {
            "allowInsecure": false,
            "serverName": "v2.example.com"
          },
          "wsSettings": {
            "path": "/1976f7/",
            "headers": {
              "Host": "v2.example.com"
            }
          }
        }
      },{
        "protocol": "freedom",
        "settings": {},
        "tag": "direct"
      },{
        "protocol": "blackhole",
        "settings": {},
        "tag": "blocked"
      }],
    
      "routing": {
        "domainStrategy": "IPOnDemand",
        "rules":[
          {
            "type": "field",
            "ip": ["geoip:private"],
            "outboundTag": "blocked"
          },
          {
            "type": "field",
            "domain": ["geosite:category-ads"],
            "outboundTag": "blocked"
          }
        ]
      },
    
      "dns": {
        "servers": [
          "1.1.1.1",
          "8.8.8.8",
          "localhost"
        ]
      },
    
      "policy": {
        "levels": {
          "0": {
            "uplinkOnly": 0,
            "downlinkOnly": 0
          }
        },
        "system": {
          "statsInboundUplink": false,
          "statsInboundDownlink": false,
          "statsOutboundUplink": false,
          "statsOutboundDownlink": false
        }
      },
    
      "other": {}
    }
</pre>
            <p>2.4. Start the V2Ray client running:</p>
            <blockquote>
                <code>./v2ray -config config.json</code>
            </blockquote>
            <p>2.5. Edit the generated OpenVPN client configuration file, e.g. <code>v2.ovpn</code>. Append a line:</p>
            <blockquote>
                <code>socks-proxy 127.0.0.1</code>
            </blockquote>
            <p>2.6. Now you can import the OpenVPN client configuration <code>v2.ovpn</code> into your client. On Ubuntu with GNOME desktop, you typically do the import in the
            Settings GUI.</p>
            <p>2.7. Add a static route from the client to the server, so that it does not try to send OpenVPN traffic via V2Ray, then V2Ray via OpenVPN, in a continuous and
            never-ending loop. For example, if your gateway is <code>10.0.0.1</code> and your interface is <code>wlp3s0</code>:</p>
            <blockquote>
                <code>sudo ip route add 123.123.123.123 via 10.0.0.1 dev wlp3s0</code>
            </blockquote>
            <p>2.8. Start the OpenVPN connection on the client.</p>
            <p>2.9. OpenVPN on the client now goes to the V2Ray client, which goes to the V2Ray server, which goes to the OpenVPN server. Your OpenVPN connection is hidden inside
            your V2Ray connection.</p>
            <p>2.10. To end the process, stop OpenVPN on the client, delete the static route, and stop V2Ray on the client.</p>
            <p><em>Updated 2022-02-03</em></p>
        </div>
    </div>
    <div id="footer">
        <div class="content">
            <p>This site is provided for information only. It cannot replace the advice of a trained security professional. If lives or safety depend on your security, please seek
            the advice of an expert.</p>
        </div>
    </div>
</body>
</html>